<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>DB Migration Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-200">

<div class="flex h-screen">

    <!-- Sidebar -->
    <aside class="w-64 bg-gray-800 p-4">
        <h1 class="text-xl font-bold mb-6">DB Migration</h1>
        <button onclick="openPopup()"
                class="bg-blue-600 px-4 py-2 rounded w-full">
            Start Migration
        </button>
    </aside>

    <!-- Main -->
    <main class="flex-1 p-6">

        <!-- Progress -->
        <div class="mb-6">
            <h2 class="font-semibold mb-2">Progress</h2>
            <div class="w-full bg-gray-700 rounded">
                <div id="progressBar"
                     class="bg-green-500 h-4 rounded w-0"></div>
            </div>
            <p id="statusText" class="mt-2 text-sm"></p>
        </div>

        <!-- Logs -->
        <div class="bg-gray-800 p-4 rounded h-96 overflow-auto">
            <h2 class="font-semibold mb-2">Logs</h2>
            <pre id="logs" class="text-sm"></pre>
        </div>
    </main>
</div>

<!-- Popup -->
<div id="popup"
     class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center">

    <div class="bg-gray-800 p-6 rounded w-96">
        <h3 class="font-semibold mb-4">Start Migration</h3>

        <input id="sourceId" placeholder="Source DB ID"
               class="w-full mb-3 p-2 bg-gray-700 rounded">

        <input id="targetId" placeholder="Target DB ID"
               class="w-full mb-3 p-2 bg-gray-700 rounded">

        <div class="flex justify-end gap-2">
            <button onclick="closePopup()">Cancel</button>
            <button onclick="startMigration()"
                    class="bg-blue-600 px-4 py-2 rounded">
                Start
            </button>
        </div>
    </div>
</div>

<script>
let jobId = null;

function openPopup() {
    document.getElementById("popup").classList.remove("hidden");
}
function closePopup() {
    document.getElementById("popup").classList.add("hidden");
}

function startMigration() {

    fetch("/migration/start", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded"},
        body: new URLSearchParams({
            sourceId: document.getElementById("sourceId").value,
            targetId: document.getElementById("targetId").value
        })
    })
    .then(r => r.text())
    .then(id => {
        jobId = id;
        closePopup();
        poll();
    });
}

function poll() {
    setInterval(() => {
        fetch("/migration/job/" + jobId)
            .then(r => r.json())
            .then(j => {
                document.getElementById("statusText").innerText = j.status;
                if (j.status === "SUCCESS") {
                    document.getElementById("progressBar").style.width = "100%";
                    alert("Migration completed");
                }
                if (j.status === "FAILED") {
                    alert("Migration failed: " + j.errorMessage);
                }
            });

        fetch("/migration/logs/" + jobId)
            .then(r => r.json())
            .then(logs => {
                let txt = logs.map(l => l.logTime + " - " + l.message).join("\n");
                document.getElementById("logs").innerText = txt;
                document.getElementById("progressBar").style.width =
                    Math.min(logs.length * 10, 100) + "%";
            });
    }, 2000);
}
</script>

</body>
</html>
